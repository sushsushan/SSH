#!/bin/bash

# Mega WordPress Bash Tool - Auto-detects WP site and gathers important details

# Function to find the WordPress directory
find_wp_directory() {
    DOMAIN=$1
    SEARCH_DIR="/var/www /home /usr/local/apache/htdocs"

    for dir in $SEARCH_DIR; do
        WP_PATH=$(find "$dir" -type f -name "wp-config.php" 2>/dev/null | grep "$DOMAIN")
        if [ -n "$WP_PATH" ]; then
            echo "$(dirname "$WP_PATH")"
            return
        fi
    done

    echo "WordPress installation for $DOMAIN not found."
    exit 1
}

# Function to get WordPress details
get_wp_details() {
    WP_DIR=$1
    echo "WordPress Directory: $WP_DIR"
    cd "$WP_DIR" || exit

    # Fetch basic details
    echo "=================================="
    echo "WordPress Site Information:"
    echo "=================================="
    echo "WordPress Version: $(wp core version --allow-root)"
    echo "Site URL: $(wp option get siteurl --allow-root)"
    echo "Home URL: $(wp option get home --allow-root)"
    echo "Database Name: $(wp config get DB_NAME --allow-root)"
    echo "Database User: $(wp config get DB_USER --allow-root)"
    echo "Database Host: $(wp config get DB_HOST --allow-root)"
    
    # Get theme and plugin details
    echo "=================================="
    echo "Active Theme: $(wp theme list --status=active --allow-root)"
    echo "Installed Plugins:"
    wp plugin list --allow-root

    # Security and performance checks
    echo "=================================="
    echo "Security & Performance Check:"
    echo "=================================="
    echo "Checking file permissions..."
    find . -type d -exec chmod 755 {} \;
    find . -type f -exec chmod 644 {} \;
    echo "Permissions Fixed."

    echo "Checking for outdated plugins..."
    wp plugin update --dry-run --allow-root

    echo "Checking for slow-loading elements..."
    wp transient delete --all --allow-root
    echo "Cache cleared."

    echo "=================================="
    echo "Mega WordPress Bash Tool Completed!"
    echo "=================================="
}

# Main Execution
if [ -z "$1" ]; then
    echo "Usage: ./wp-tool.sh example.com"
    exit 1
fi

WP_DIR=$(find_wp_directory "$1")
get_wp_details "$WP_DIR"
